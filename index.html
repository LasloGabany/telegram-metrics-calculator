<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –º–µ—Ç—Ä–∏–∫ –ø–æ–¥–ø–∏—Å–∫–∏</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* ... (–ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å—Ç–∏–ª–∏) ... */
    
    /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è Telegram */
    .tg-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding: 10px 0;
    }
    
    .tg-title {
      font-size: 1.5rem;
      font-weight: bold;
    }
    
    .tg-button {
      background: var(--tg-theme-button-color, #3390ec);
      color: var(--tg-theme-button-text-color, #ffffff);
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: opacity 0.3s;
    }
    
    .tg-button:hover {
      opacity: 0.9;
    }
    
    .tg-main-button {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--tg-theme-button-color, #3390ec);
      color: var(--tg-theme-button-text-color, #ffffff);
      border: none;
      border-radius: 10px;
      padding: 12px 24px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1000;
    }
    
    /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è Telegram */
    body {
      background-color: var(--tg-theme-bg-color, #ffffff);
      color: var(--tg-theme-text-color, #000000);
      padding: 15px;
      padding-bottom: 80px; /* –ú–µ—Å—Ç–æ –¥–ª—è –∫–Ω–æ–ø–∫–∏ */
    }
    
    .card {
      background-color: var(--tg-theme-secondary-bg-color, #f5f5f5);
      border: 1px solid var(--tg-theme-section-separator-color, #e0e0e0);
    }
    
    input {
      background-color: var(--tg-theme-bg-color, #ffffff);
      color: var(--tg-theme-text-color, #000000);
      border: 1px solid var(--tg-theme-hint-color, #999999);
    }
    
    .metric-card {
      background-color: var(--tg-theme-secondary-bg-color, #f5f5f5);
      border-left-color: var(--tg-theme-button-color, #3390ec);
    }
    
    .metric-value {
      color: var(--tg-theme-button-color, #3390ec);
    }
    
    .btn {
      background-color: var(--tg-theme-button-color, #3390ec);
      color: var(--tg-theme-button-text-color, #ffffff);
    }
    
    .btn-secondary {
      background-color: var(--tg-theme-secondary-bg-color, #f5f5f5);
      color: var(--tg-theme-text-color, #000000);
      border: 1px solid var(--tg-theme-hint-color, #999999);
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è Telegram */
    .tg-stats {
      display: flex;
      justify-content: space-around;
      margin: 20px 0;
      padding: 15px;
      background-color: var(--tg-theme-secondary-bg-color, #f5f5f5);
      border-radius: 12px;
    }
    
    .tg-stat {
      text-align: center;
    }
    
    .tg-stat-value {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--tg-theme-button-color, #3390ec);
    }
    
    .tg-stat-label {
      font-size: 0.8rem;
      color: var(--tg-theme-hint-color, #999999);
    }
    
    .tg-share-section {
      margin-top: 30px;
      text-align: center;
    }
    
    .tg-share-button {
      background: linear-gradient(135deg, #0088cc, #00a2ff);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px 20px;
      font-size: 0.9rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin: 0 5px;
    }
    
    @media (max-width: 480px) {
      .grid {
        grid-template-columns: 1fr;
        gap: 15px;
      }
      
      .card {
        padding: 15px;
      }
      
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="tg-header">
      <div class="tg-title">–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –º–µ—Ç—Ä–∏–∫</div>
      <button class="tg-button" onclick="closeApp()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
    
    <div class="tg-stats">
      <div class="tg-stat">
        <div class="tg-stat-value" id="tgLTV">--</div>
        <div class="tg-stat-label">LTV</div>
      </div>
      <div class="tg-stat">
        <div class="tg-stat-value" id="tgCAC">--</div>
        <div class="tg-stat-label">CAC</div>
      </div>
      <div class="tg-stat">
        <div class="tg-stat-value" id="tgEfficiency">--</div>
        <div class="tg-stat-label">–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div>
      </div>
    </div>

    <div class="grid">
      <!-- –í–•–û–î–ù–´–ï –ü–û–ö–ê–ó–ê–¢–ï–õ–ò -->
      <div class="card">
        <h2>–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h2>
        
        <div class="form-group">
          <label for="startSubs">–ù–∞—á–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤</label>
          <input type="number" id="startSubs" min="0" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤">
        </div>
        
        <div class="form-group">
          <label for="churnUsers">–û—Ç—Ç–æ–∫ –∑–∞ –ø–µ—Ä–∏–æ–¥</label>
          <input type="number" id="churnUsers" min="0" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–ø–∏—Å–∞–≤—à–∏—Ö—Å—è">
        </div>
        
        <div class="form-group">
          <label for="marketingSpend">–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã–µ —Ä–∞—Å—Ö–æ–¥—ã, ‚ÇΩ</label>
          <input type="number" id="marketingSpend" min="0" placeholder="–ó–∞—Ç—Ä–∞—Ç—ã –Ω–∞ —Ä–µ–∫–ª–∞–º—É">
        </div>
        
        <div class="form-group">
          <label for="newSubs">–ù–æ–≤—ã–µ –ø–æ–¥–ø–∏—Å—á–∏–∫–∏</label>
          <input type="number" id="newSubs" min="0" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤">
        </div>
        
        <div class="form-group">
          <label for="newSubsMonthly">–ù–æ–≤—ã—Ö –≤ –º–µ—Å—è—Ü</label>
          <input type="number" id="newSubsMonthly" min="0" placeholder="–°—Ç–∞–±–∏–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫">
        </div>
        
        <div class="form-group">
          <label for="price">–°—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ–¥–ø–∏—Å–∫–∏, ‚ÇΩ</label>
          <input type="number" id="price" min="0" step="0.01" placeholder="–¶–µ–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∏">
        </div>
        
        <div class="form-group">
          <label for="grossMargin">–í–∞–ª–æ–≤–∞—è –º–∞—Ä–∂–∞, %</label>
          <input type="number" id="grossMargin" min="0" max="100" placeholder="–î–æ–ª—è –ø—Ä–∏–±—ã–ª–∏">
        </div>
        
        <div class="actions">
          <button class="btn" onclick="calculate()">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
          <button class="btn btn-secondary" onclick="resetForm()">–°–±—Ä–æ—Å</button>
        </div>
      </div>
      
      <!-- –†–ï–ó–£–õ–¨–¢–ê–¢–´ -->
      <div class="card">
        <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</h2>
        
        <div id="results" class="results">
          <div style="grid-column: 1/-1; text-align: center; padding: 20px;">
            –í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –∏ –Ω–∞–∂–º–∏—Ç–µ "–†–∞—Å—Å—á–∏—Ç–∞—Ç—å"
          </div>
        </div>
        
        <div class="traffic-light">
          <div id="trafficLight" class="light neutral">?</div>
        </div>
        
        <div class="actions">
          <button class="btn" onclick="copyResults()">
            <span>üìã</span> –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
          </button>
        </div>
      </div>
    </div>
    
    <!-- –î–≠–®–ë–û–†–î -->
    <div class="card">
      <h2>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h2>
      
      <div class="chart-container">
        <canvas id="metricsChart"></canvas>
      </div>
      
      <div class="detailed-metrics">
        <div class="metric-item">
          <div class="metric-label">ROMI</div>
          <div class="metric-value" id="romi">--</div>
        </div>
        <div class="metric-item">
          <div class="metric-label">–û–∫—É–ø–∞–µ–º–æ—Å—Ç—å</div>
          <div class="metric-value" id="breakEven">--</div>
        </div>
      </div>
      
      <div class="summary-card">
        <h3>–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –±–∏–∑–Ω–µ—Å–∞</h3>
        <div class="progress-bar">
          <div class="progress-fill" id="efficiencyBar"></div>
        </div>
        <div class="summary-text" id="summaryText">
          –í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
        </div>
      </div>
    </div>
    
    <div class="tg-share-section">
      <button class="tg-share-button" onclick="shareResults()">
        <span>üì§</span> –ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
      </button>
      <button class="tg-share-button" onclick="generateReport()">
        <span>üìä</span> –ü–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç
      </button>
    </div>
  </div>
  
  <button class="tg-main-button" onclick="calculate()">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –º–µ—Ç—Ä–∏–∫–∏</button>
  
  <div id="toast" class="toast">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã!</div>

  <script>
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
    let tg = window.Telegram.WebApp;
    tg.expand(); // –†–∞—Å—à–∏—Ä—è–µ–º –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–º—É Telegram
    function applyTelegramTheme() {
      const root = document.documentElement;
      
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º CSS –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ —Ç–µ–º—ã Telegram
      root.style.setProperty('--tg-theme-bg-color', tg.themeParams.bg_color || '#ffffff');
      root.style.setProperty('--tg-theme-text-color', tg.themeParams.text_color || '#000000');
      root.style.setProperty('--tg-theme-hint-color', tg.themeParams.hint_color || '#999999');
      root.style.setProperty('--tg-theme-link-color', tg.themeParams.link_color || '#3390ec');
      root.style.setProperty('--tg-theme-button-color', tg.themeParams.button_color || '#3390ec');
      root.style.setProperty('--tg-theme-button-text-color', tg.themeParams.button_text_color || '#ffffff');
      root.style.setProperty('--tg-theme-secondary-bg-color', tg.themeParams.secondary_bg_color || '#f5f5f5');
      root.style.setProperty('--tg-theme-section-separator-color', tg.themeParams.section_separator_color || '#e0e0e0');
    }
    
    // –í—ã–∑—ã–≤–∞–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    applyTelegramTheme();
    
    // –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    function closeApp() {
      tg.close();
    }
    
    // –§—É–Ω–∫—Ü–∏—è –ø–æ–¥–µ–ª–∏—Ç—å—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
    function shareResults() {
      const resultsText = document.getElementById('results').innerText;
      
      if (resultsText && resultsText !== '–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –∏ –Ω–∞–∂–º–∏—Ç–µ "–†–∞—Å—Å—á–∏—Ç–∞—Ç—å"') {
        tg.shareMessage(`–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—Å—á–µ—Ç–∞ –º–µ—Ç—Ä–∏–∫ –ø–æ–¥–ø–∏—Å–∫–∏:\n\n${resultsText}`);
      } else {
        showToast('–°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Ä–∞—Å—á–µ—Ç');
      }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }
    
    // –§—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —á–∏—Å–µ–ª
    const fmt = (n, d = 2) => {
      return new Intl.NumberFormat('ru-RU', {
        maximumFractionDigits: d,
        minimumFractionDigits: d
      }).format(n);
    };
    
    // –ü–æ–ª—É—á–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ DOM
    const elements = {
      startSubs: document.getElementById('startSubs'),
      churnUsers: document.getElementById('churnUsers'),
      marketingSpend: document.getElementById('marketingSpend'),
      newSubs: document.getElementById('newSubs'),
      newSubsMonthly: document.getElementById('newSubsMonthly'),
      price: document.getElementById('price'),
      grossMargin: document.getElementById('grossMargin'),
      results: document.getElementById('results'),
      trafficLight: document.getElementById('trafficLight'),
      toast: document.getElementById('toast'),
      romi: document.getElementById('romi'),
      breakEven: document.getElementById('breakEven'),
      efficiencyBar: document.getElementById('efficiencyBar'),
      summaryText: document.getElementById('summaryText'),
      tgLTV: document.getElementById('tgLTV'),
      tgCAC: document.getElementById('tgCAC'),
      tgEfficiency: document.getElementById('tgEfficiency')
    };
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–∞
    const ctx = document.getElementById('metricsChart').getContext('2d');
    const metricsChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: ['–Ø–Ω–≤', '–§–µ–≤', '–ú–∞—Ä', '–ê–ø—Ä', '–ú–∞–π', '–ò—é–Ω'],
        datasets: [{
          label: 'LTV',
          data: [12000, 13500, 14200, 15000, 15800, 16500],
          borderColor: tg.themeParams.link_color || '#3390ec',
          tension: 0.4
        }, {
          label: 'CAC',
          data: [8000, 8200, 7900, 8100, 7800, 7600],
          borderColor: '#10b981',
          tension: 0.4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            labels: {
              color: tg.themeParams.text_color || '#000000'
            }
          }
        },
        scales: {
          y: {
            ticks: {
              color: tg.themeParams.hint_color || '#999999'
            },
            grid: {
              color: tg.themeParams.section_separator_color || '#e0e0e0'
            }
          },
          x: {
            ticks: {
              color: tg.themeParams.hint_color || '#999999'
            },
            grid: {
              color: tg.themeParams.section_separator_color || '#e0e0e0'
            }
          }
        }
      }
    });
    
    // –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ ROMI
    function calculateROMI(ltv, cac) {
      return ((ltv - cac) / cac * 100).toFixed(1);
    }
    
    // –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ break-even
    function calculateBreakEven(cac, arpu) {
      return (cac / arpu).toFixed(1);
    }
    
    // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ —Å–≤–æ–¥–∫–∏
    function getSummaryText(efficiency) {
      if (efficiency >= 80) return "–û—Ç–ª–∏—á–Ω–∞—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å! –ë–∏–∑–Ω–µ—Å –æ—á–µ–Ω—å —É—Å—Ç–æ–π—á–∏–≤.";
      if (efficiency >= 60) return "–•–æ—Ä–æ—à–∞—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å. –ï—Å—Ç—å –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª —Ä–æ—Å—Ç–∞.";
      if (efficiency >= 40) return "–°—Ä–µ–¥–Ω—è—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å. –ù—É–∂–Ω–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è.";
      return "–ù–∏–∑–∫–∞—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å. –¢—Ä–µ–±—É–µ—Ç—Å—è –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–æ.";
    }
    
    // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞
    function calculate() {
      // –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π –∏–∑ –ø–æ–ª–µ–π
      const data = {
        startSubs: parseFloat(elements.startSubs.value) || 0,
        churnUsers: parseFloat(elements.churnUsers.value) || 0,
        marketingSpend: parseFloat(elements.marketingSpend.value) || 0,
        newSubs: parseFloat(elements.newSubs.value) || 0,
        newSubsMonthly: parseFloat(elements.newSubsMonthly.value) || 0,
        price: parseFloat(elements.price.value) || 0,
        grossMargin: parseFloat(elements.grossMargin.value) || 0
      };
      
      // –†–∞—Å—á–µ—Ç –º–µ—Ç—Ä–∏–∫
      const churnRate = data.startSubs > 0 ? data.churnUsers / data.startSubs : 0;
      const retention = 1 - churnRate;
      const cac = data.newSubs > 0 ? data.marketingSpend / data.newSubs : 0;
      const arpu = data.price * (data.grossMargin / 100);
      const ltv = retention > 0 && retention < 1 ? arpu * (retention / (1 - retention)) : 0;
      const payback = arpu > 0 ? cac / arpu : 0;
      const ratio = ltv > 0 ? cac / ltv : 0;
      
      // –†–∞—Å—á–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫
      const romi = calculateROMI(ltv, cac);
      const breakEven = calculateBreakEven(cac, arpu);
      const efficiency = Math.min(100, Math.max(0, (ltv / cac - 1) * 50));
      
      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
      elements.results.innerHTML = `
        <div class="metric-card">
          <div class="metric-label">–û—Ç—Ç–æ–∫</div>
          <div class="metric-value">${fmt(churnRate * 100)}%</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">–£–¥–µ—Ä–∂–∞–Ω–∏–µ</div>
          <div class="metric-value">${fmt(retention * 100)}%</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">CAC</div>
          <div class="metric-value">${fmt(cac)} ‚ÇΩ</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">LTV</div>
          <div class="metric-value">${fmt(ltv)} ‚ÇΩ</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">–û–∫—É–ø–∞–µ–º–æ—Å—Ç—å</div>
          <div class="metric-value">${fmt(payback, 1)} –º–µ—Å.</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">CAC/LTV</div>
          <div class="metric-value">${fmt(ratio * 100)}%</div>
        </div>
      `;
      
      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–≤–µ—Ç–æ—Ñ–æ—Ä–∞
      if (ratio <= 0.33 && payback <= 6) {
        elements.trafficLight.className = 'light green';
        elements.trafficLight.textContent = '‚úì';
      } else if (ratio <= 0.50 && payback <= 12) {
        elements.trafficLight.className = 'light yellow';
        elements.trafficLight.textContent = '!';
      } else {
        elements.trafficLight.className = 'light red';
        elements.trafficLight.textContent = '‚úó';
      }
      
      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–µ—Ç–∞–ª—å–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫
      elements.romi.textContent = romi + '%';
      elements.breakEven.textContent = breakEven + ' –º–µ—Å.';
      
      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–≤–æ–¥–∫–∏
      elements.efficiencyBar.style.width = efficiency + '%';
      elements.summaryText.textContent = getSummaryText(efficiency);
      
      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Telegram —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
      elements.tgLTV.textContent = fmt(ltv) + ' ‚ÇΩ';
      elements.tgCAC.textContent = fmt(cac) + ' ‚ÇΩ';
      elements.tgEfficiency.textContent = efficiency.toFixed(0) + '%';
      
      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞
      updateChart(ltv, cac);
      
      // –í–∏–±—Ä–∞—Ü–∏—è –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏
      if (tg.HapticFeedback) {
        tg.HapticFeedback.impactOccurred('medium');
      }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞
    function updateChart(ltv, cac) {
      const currentMonth = new Date().toLocaleString('ru', { month: 'short' });
      
      metricsChart.data.datasets[0].data.push(ltv);
      if (metricsChart.data.datasets[0].data.length > 6) {
        metricsChart.data.datasets[0].data.shift();
      }
      
      metricsChart.data.datasets[1].data.push(cac);
      if (metricsChart.data.datasets[1].data.length > 6) {
        metricsChart.data.datasets[1].data.shift();
      }
      
      metricsChart.data.labels.push(currentMonth);
      if (metricsChart.data.labels.length > 6) {
        metricsChart.data.labels.shift();
      }
      
      metricsChart.update();
    }
    
    // –§—É–Ω–∫—Ü–∏—è —Å–±—Ä–æ—Å–∞ —Ñ–æ—Ä–º—ã
    function resetForm() {
      elements.startSubs.value = '';
      elements.churnUsers.value = '';
      elements.marketingSpend.value = '';
      elements.newSubs.value = '';
      elements.newSubsMonthly.value = '';
      elements.price.value = '';
      elements.grossMargin.value = '';
      
      elements.results.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 20px;">–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –∏ –Ω–∞–∂–º–∏—Ç–µ "–†–∞—Å—Å—á–∏—Ç–∞—Ç—å"</div>';
      elements.trafficLight.className = 'light neutral';
      elements.trafficLight.textContent = '?';
      
      elements.romi.textContent = '--';
      elements.breakEven.textContent = '--';
      
      elements.efficiencyBar.style.width = '0%';
      elements.summaryText.textContent = '–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞';
      
      elements.tgLTV.textContent = '--';
      elements.tgCAC.textContent = '--';
      elements.tgEfficiency.textContent = '--';
    }
    
    // –§—É–Ω–∫—Ü–∏—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    function copyResults() {
      const resultsText = Array.from(elements.results.querySelectorAll('.metric-card'))
        .map(card => {
          const label = card.querySelector('.metric-label').textContent;
          const value = card.querySelector('.metric-value').textContent;
          return `${label}: ${value}`;
        })
        .join('\n');
      
      navigator.clipboard.writeText(resultsText)
        .then(() => {
          showToast('–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã!');
        });
    }
    
    // –§—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞
    function generateReport() {
      // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ
      const data = {
        startSubs: parseFloat(elements.startSubs.value) || 0,
        churnUsers: parseFloat(elements.churnUsers.value) || 0,
        marketingSpend: parseFloat(elements.marketingSpend.value) || 0,
        newSubs: parseFloat(elements.newSubs.value) || 0,
        newSubsMonthly: parseFloat(elements.newSubsMonthly.value) || 0,
        price: parseFloat(elements.price.value) || 0,
        grossMargin: parseFloat(elements.grossMargin.value) || 0
      };
      
      // –†–∞—Å—á–µ—Ç –º–µ—Ç—Ä–∏–∫
      const churnRate = data.startSubs > 0 ? data.churnUsers / data.startSubs : 0;
      const retention = 1 - churnRate;
      const cac = data.newSubs > 0 ? data.marketingSpend / data.newSubs : 0;
      const arpu = data.price * (data.grossMargin / 100);
      const ltv = retention > 0 && retention < 1 ? arpu * (retention / (1 - retention)) : 0;
      const payback = arpu > 0 ? cac / arpu : 0;
      const ratio = ltv > 0 ? cac / ltv : 0;
      const romi = calculateROMI(ltv, cac);
      const breakEven = calculateBreakEven(cac, arpu);
      const efficiency = Math.min(100, Math.max(0, (ltv / cac - 1) * 50));
      
      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
      let status, statusColor, recommendations;
      if (efficiency >= 80) {
        status = "–û—Ç–ª–∏—á–Ω–∞—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å";
        statusColor = "#27ae60";
        recommendations = `
          <ul>
            <li>–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–π—Ç–µ –±–∏–∑–Ω–µ—Å: —É–≤–µ–ª–∏—á–∏–≤–∞–π—Ç–µ –±—é–¥–∂–µ—Ç –Ω–∞ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥</li>
            <li>–†–∞—Å—à–∏—Ä—è–π—Ç–µ –≥–µ–æ–≥—Ä–∞—Ñ–∏—é –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è</li>
            <li>–î–æ–±–∞–≤–ª—è–π—Ç–µ –Ω–æ–≤—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã –∏–ª–∏ —É—Å–ª—É–≥–∏</li>
            <li>–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ –≤—ã—Å–æ–∫–∏–π —É—Ä–æ–≤–µ–Ω—å —Å–µ—Ä–≤–∏—Å–∞</li>
          </ul>
        `;
      } else if (efficiency >= 60) {
        status = "–•–æ—Ä–æ—à–∞—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å";
        statusColor = "#f39c12";
        recommendations = `
          <ul>
            <li>–†–∞–±–æ—Ç–∞–π—Ç–µ –Ω–∞–¥ —É–¥–µ—Ä–∂–∞–Ω–∏–µ–º –∫–ª–∏–µ–Ω—Ç–æ–≤</li>
            <li>–û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π—Ç–µ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã–µ –∫–∞–Ω–∞–ª—ã</li>
            <li>–£–ª—É—á—à–∞–π—Ç–µ –ø—Ä–æ–¥—É–∫—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏</li>
            <li>–¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ –Ω–æ–≤—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –º–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏–∏</li>
          </ul>
        `;
      } else {
        status = "–¢—Ä–µ–±—É–µ—Ç—Å—è —É–ª—É—á—à–µ–Ω–∏–µ";
        statusColor = "#e74c3c";
        recommendations = `
          <ul>
            <li>–°—Ä–æ—á–Ω–æ —Å–Ω–∏–∂–∞–π—Ç–µ —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤ (CAC)</li>
            <li>–ü–æ–≤—ã—à–∞–π—Ç–µ –ø–æ–∂–∏–∑–Ω–µ–Ω–Ω—É—é —Ü–µ–Ω–Ω–æ—Å—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ (LTV)</li>
            <li>–ü–µ—Ä–µ—Å–º–æ—Ç—Ä–∏—Ç–µ –±–∏–∑–Ω–µ—Å-–º–æ–¥–µ–ª—å</li>
            <li>–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É–π—Ç–µ –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã</li>
          </ul>
        `;
      }
      
      // –°–æ–∑–¥–∞–µ–º HTML –æ—Ç—á–µ—Ç–∞
      const reportHTML = `
        <!DOCTYPE html>
        <html lang="ru">
        <head>
          <meta charset="UTF-8"/>
          <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
          <title>–û—Ç—á–µ—Ç –ø–æ –º–µ—Ç—Ä–∏–∫–∞–º –ø–æ–¥–ø–∏—Å–∫–∏</title>
          <style>
            body {
              font-family: 'Arial', sans-serif;
              line-height: 1.6;
              color: #333;
              margin: 0;
              padding: 20px;
              background-color: #f9f9f9;
            }
            
            .report-container {
              max-width: 800px;
              margin: 0 auto;
              padding: 20px;
              background-color: white;
              border-radius: 8px;
              box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            }
            
            .report-header {
              text-align: center;
              margin-bottom: 30px;
              border-bottom: 2px solid #3498db;
              padding-bottom: 20px;
            }
            
            .report-title {
              color: #2c3e50;
              font-size: 28px;
              margin-bottom: 10px;
            }
            
            .report-date {
              color: #7f8c8d;
              font-size: 16px;
            }
            
            .report-section {
              margin-bottom: 30px;
            }
            
            .report-section-title {
              color: #3498db;
              font-size: 20px;
              margin-bottom: 15px;
              padding-bottom: 5px;
              border-bottom: 1px solid #ddd;
            }
            
            .report-table {
              width: 100%;
              border-collapse: collapse;
              margin-bottom: 20px;
            }
            
            .report-table th, .report-table td {
              padding: 12px;
              text-align: left;
              border-bottom: 1px solid #ddd;
            }
            
            .report-table th {
              background-color: #f8f9fa;
              font-weight: bold;
            }
            
            .report-metric {
              background-color: #f8f9fa;
              border-radius: 8px;
              padding: 15px;
              margin-bottom: 15px;
              box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            }
            
            .report-metric-title {
              font-weight: bold;
              color: #2c3e50;
              margin-bottom: 5px;
            }
            
            .report-metric-value {
              font-size: 24px;
              font-weight: bold;
              color: #3498db;
            }
            
            .report-efficiency {
              text-align: center;
              margin: 30px 0;
            }
            
            .report-efficiency-bar {
              height: 30px;
              background: linear-gradient(to right, #e74c3c, #f39c12, #27ae60);
              border-radius: 15px;
              position: relative;
              margin: 20px 0;
            }
            
            .report-efficiency-marker {
              position: absolute;
              top: -10px;
              width: 50px;
              height: 50px;
              background-color: white;
              border: 4px solid #3498db;
              border-radius: 50%;
              transform: translateX(-50%);
              display: flex;
              align-items: center;
              justify-content: center;
              font-weight: bold;
            }
            
            .report-recommendations {
              background-color: #e8f4fc;
              border-left: 4px solid #3498db;
              padding: 20px;
              margin: 20px 0;
              border-radius: 0 4px 4px 0;
            }
            
            .report-recommendations h3 {
              margin-top: 0;
              color: #2c3e50;
            }
            
            .report-recommendations ul {
              margin-bottom: 0;
              padding-left: 20px;
            }
            
            .report-footer {
              text-align: center;
              margin-top: 40px;
              padding-top: 20px;
              border-top: 1px solid #ddd;
              color: #7f8c8d;
              font-size: 14px;
            }
            
            @media print {
              body {
                background-color: white;
                padding: 0;
              }
              
              .report-container {
                box-shadow: none;
                max-width: 100%;
                margin: 0;
                padding: 20px;
              }
            }
          </style>
        </head>
        <body>
          <div class="report-container">
            <div class="report-header">
              <h1 class="report-title">–û—Ç—á–µ—Ç –ø–æ –º–µ—Ç—Ä–∏–∫–∞–º –ø–æ–¥–ø–∏—Å–∫–∏</h1>
              <div class="report-date">–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è: ${new Date().toLocaleDateString('ru-RU')}</div>
            </div>
            
            <div class="report-section">
              <h2 class="report-section-title">–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h2>
              <table class="report-table">
                <tr>
                  <th>–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å</th>
                  <th>–ó–Ω–∞—á–µ–Ω–∏–µ</th>
                </tr>
                <tr>
                  <td>–ù–∞—á–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤</td>
                  <td>${fmt(data.startSubs)}</td>
                </tr>
                <tr>
                  <td>–û—Ç—Ç–æ–∫ –∑–∞ –ø–µ—Ä–∏–æ–¥</td>
                  <td>${fmt(data.churnUsers)}</td>
                </tr>
                <tr>
                  <td>–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã–µ —Ä–∞—Å—Ö–æ–¥—ã</td>
                  <td>${fmt(data.marketingSpend)} ‚ÇΩ</td>
                </tr>
                <tr>
                  <td>–ù–æ–≤—ã–µ –ø–æ–¥–ø–∏—Å—á–∏–∫–∏ –∑–∞ –ø–µ—Ä–∏–æ–¥</td>
                  <td>${fmt(data.newSubs)}</td>
                </tr>
                <tr>
                  <td>–ù–æ–≤—ã–µ –ø–æ–¥–ø–∏—Å—á–∏–∫–∏ –≤ –º–µ—Å—è—Ü</td>
                  <td>${fmt(data.newSubsMonthly)}</td>
                </tr>
                <tr>
                  <td>–°—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ–¥–ø–∏—Å–∫–∏</td>
                  <td>${fmt(data.price)} ‚ÇΩ</td>
                </tr>
                <tr>
                  <td>–í–∞–ª–æ–≤–∞—è –º–∞—Ä–∂–∞</td>
                  <td>${fmt(data.grossMargin)}%</td>
                </tr>
              </table>
            </div>
            
            <div class="report-section">
              <h2 class="report-section-title">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—Å—á–µ—Ç–æ–≤</h2>
              
              <div class="report-metric">
                <div class="report-metric-title">–û—Ç—Ç–æ–∫ (Churn Rate)</div>
                <div class="report-metric-value">${fmt(churnRate * 100)}%</div>
              </div>
              
              <div class="report-metric">
                <div class="report-metric-title">–£–¥–µ—Ä–∂–∞–Ω–∏–µ (Retention Rate)</div>
                <div class="report-metric-value">${fmt(retention * 100)}%</div>
              </div>
              
              <div class="report-metric">
                <div class="report-metric-title">–°—Ç–æ–∏–º–æ—Å—Ç—å –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è (CAC)</div>
                <div class="report-metric-value">${fmt(cac)} ‚ÇΩ</div>
              </div>
              
              <div class="report-metric">
                <div class="report-metric-title">–ü–æ–∂–∏–∑–Ω–µ–Ω–Ω–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å (LTV)</div>
                <div class="report-metric-value">${fmt(ltv)} ‚ÇΩ</div>
              </div>
              
              <div class="report-metric">
                <div class="report-metric-title">–û–∫—É–ø–∞–µ–º–æ—Å—Ç—å</div>
                <div class="report-metric-value">${fmt(payback, 1)} –º–µ—Å.</div>
              </div>
              
              <div class="report-metric">
                <div class="report-metric-title">–°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ CAC/LTV</div>
                <div class="report-metric-value">${fmt(ratio * 100)}%</div>
              </div>
              
              <div class="report-metric">
                <div class="report-metric-title">ROMI</div>
                <div class="report-metric-value">${romi}%</div>
              </div>
              
              <div class="report-metric">
                <div class="report-metric-title">–¢–æ—á–∫–∞ –±–µ–∑—É–±—ã—Ç–æ—á–Ω–æ—Å—Ç–∏</div>
                <div class="report-metric-value">${breakEven} –º–µ—Å.</div>
              </div>
            </div>
            
            <div class="report-section">
              <h2 class="report-section-title">–°–≤–æ–¥–∫–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</h2>
              
              <div class="report-efficiency">
                <div style="font-size: 18px; margin-bottom: 10px;">–£—Ä–æ–≤–µ–Ω—å —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –≤–∞—à–µ–≥–æ –±–∏–∑–Ω–µ—Å–∞</div>
                <div class="report-efficiency-bar">
                  <div class="report-efficiency-marker" style="left: ${efficiency}%; color: ${statusColor};">
                    ${efficiency.toFixed(0)}%
                  </div>
                </div>
                <div style="font-size: 24px; font-weight: bold; color: ${statusColor};">
                  ${status}
                </div>
              </div>
              
              <div class="report-recommendations">
                <h3 style="margin-top: 0;">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</h3>
                ${recommendations}
              </div>
            </div>
            
            <div class="report-footer">
              <p>–û—Ç—á–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω —Å –ø–æ–º–æ—â—å—é –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ –º–µ—Ç—Ä–∏–∫ –ø–æ–¥–ø–∏—Å–∫–∏</p>
              <p>–î–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ PDF –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é –ø–µ—á–∞—Ç–∏ –±—Ä–∞—É–∑–µ—Ä–∞ (Ctrl+P)</p>
            </div>
          </div>
        </body>
        </html>
      `;
      
      // –û—Ç–∫—Ä—ã–≤–∞–µ–º –æ—Ç—á–µ—Ç –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ
      const reportWindow = window.open('', '_blank');
      reportWindow.document.write(reportHTML);
      reportWindow.document.close();
      
      showToast('–û—Ç—á–µ—Ç —Å–æ–∑–¥–∞–Ω –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ!');
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    resetForm();
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    Object.values(elements).forEach(element => {
      if (element.tagName === 'INPUT') {
        element.addEventListener('input', calculate);
      }
    });
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥–ª–∞–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
    tg.MainButton.setText('–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –º–µ—Ç—Ä–∏–∫–∏');
    tg.MainButton.onClick(calculate);
    tg.MainButton.show();
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Ç–µ–º—ã
    tg.onEvent('themeChanged', function() {
      applyTelegramTheme();
    });
  </script>
</body>
</html>