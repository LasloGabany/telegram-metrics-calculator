<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Калькулятор метрик подписки</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --secondary: #8b5cf6;
      --accent: #ec4899;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --dark: #1e293b;
      --light: #f8fafc;
      --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: var(--dark);
      line-height: 1.6;
      min-height: 100vh;
      padding: 15px;
      overflow-x: hidden;
    }

    .container {
      max-width: 100%;
      margin: 0 auto;
    }

    /* Заголовок */
    .app-header {
      text-align: center;
      margin-bottom: 25px;
      padding: 15px 0;
    }

    .app-title {
      font-size: 1.8rem;
      font-weight: 800;
      color: white;
      margin-bottom: 5px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .app-subtitle {
      color: rgba(255,255,255,0.9);
      font-size: 0.95rem;
    }

    /* Карточки */
    .card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: var(--shadow-lg);
      border: 1px solid rgba(255, 255, 255, 0.2);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 25px 30px -5px rgba(0, 0, 0, 0.15);
    }

    .card-title {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 2px solid rgba(99, 102, 241, 0.2);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .card-title::before {
      content: '';
      width: 5px;
      height: 24px;
      background: linear-gradient(to bottom, var(--primary), var(--secondary));
      border-radius: 3px;
    }

    /* Формы */
    .form-group {
      margin-bottom: 18px;
    }

    label {
      display: block;
      font-weight: 600;
      color: var(--dark);
      margin-bottom: 8px;
      font-size: 0.9rem;
    }

    input {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      font-size: 1rem;
      transition: all 0.3s ease;
      background: white;
    }

    input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
    }

    /* Кнопки */
    .btn {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
      border: none;
      padding: 14px 24px;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 15px rgba(99, 102, 241, 0.4);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn-secondary {
      background: white;
      color: var(--primary);
      border: 2px solid var(--primary);
      box-shadow: none;
    }

    .btn-secondary:hover {
      background: var(--primary);
      color: white;
    }

    .btn-group {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }

    .btn-group .btn {
      flex: 1;
    }

    /* Результаты */
    .results {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-bottom: 20px;
    }

    .metric-card {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border-radius: 16px;
      padding: 16px;
      border-left: 4px solid var(--primary);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .metric-card::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
      border-radius: 0 16px 0 60px;
    }

    .metric-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
    }

    .metric-label {
      font-size: 0.85rem;
      color: #64748b;
      margin-bottom: 5px;
      font-weight: 600;
    }

    .metric-value {
      font-size: 1.4rem;
      font-weight: 700;
      color: var(--primary);
    }

    /* Светофор */
    .traffic-light {
      display: flex;
      justify-content: center;
      margin: 25px 0;
    }

    .light {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5rem;
      color: white;
      font-weight: bold;
      box-shadow: var(--shadow-lg);
      transition: all 0.5s ease;
    }

    .light.green {
      background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
    }

    .light.yellow {
      background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%);
    }

    .light.red {
      background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
    }

    .light.neutral {
      background: linear-gradient(135deg, #94a3b8 0%, #64748b 100%);
    }

    /* Статистика вверху */
    .stats-bar {
      display: flex;
      justify-content: space-around;
      margin-bottom: 20px;
      padding: 15px;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      box-shadow: var(--shadow);
    }

    .stat-item {
      text-align: center;
    }

    .stat-value {
      font-size: 1.4rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 0.8rem;
      color: #64748b;
      font-weight: 600;
    }

    /* График */
    .chart-container {
      height: 250px;
      margin: 20px 0;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 16px;
      padding: 15px;
      box-shadow: var(--shadow);
    }

    /* Детальные метрики */
    .detailed-metrics {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin: 20px 0;
    }

    .detail-metric {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border-radius: 16px;
      padding: 15px;
      text-align: center;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    }

    .detail-metric-label {
      font-size: 0.85rem;
      color: #64748b;
      margin-bottom: 5px;
      font-weight: 600;
    }

    .detail-metric-value {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--primary);
    }

    /* Сводка эффективности */
    .efficiency-card {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
      padding: 20px;
      border-radius: 16px;
      margin: 20px 0;
      box-shadow: var(--shadow-lg);
    }

    .efficiency-title {
      font-size: 1.1rem;
      font-weight: 700;
      margin-bottom: 15px;
    }

    .progress-bar {
      height: 12px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 6px;
      overflow: hidden;
      margin: 15px 0;
    }

    .progress-fill {
      height: 100%;
      background: white;
      border-radius: 6px;
      transition: width 1s ease;
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
    }

    .efficiency-text {
      font-size: 0.95rem;
      opacity: 0.9;
    }

    /* Кнопки действий */
    .action-buttons {
      display: flex;
      gap: 12px;
      margin-top: 25px;
    }

    .action-btn {
      flex: 1;
      padding: 12px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: all 0.3s ease;
    }

    .share-btn {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .share-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 15px rgba(59, 130, 246, 0.4);
    }

    .report-btn {
      background: white;
      color: var(--primary);
      border: 2px solid var(--primary);
    }

    .report-btn:hover {
      background: var(--primary);
      color: white;
    }

    /* Уведомления */
    .toast {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--dark);
      color: white;
      padding: 14px 24px;
      border-radius: 50px;
      box-shadow: var(--shadow-lg);
      opacity: 0;
      transition: all 0.3s ease;
      z-index: 1000;
      font-weight: 600;
    }

    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    /* Анимации */
    @keyframes pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4);
      }
      70% {
        box-shadow: 0 0 0 10px rgba(99, 102, 241, 0);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(99, 102, 241, 0);
      }
    }

    .pulse {
      animation: pulse 2s infinite;
    }

    /* Адаптивность */
    @media (max-width: 768px) {
      .results {
        grid-template-columns: 1fr;
      }
      
      .detailed-metrics {
        grid-template-columns: 1fr;
      }
      
      .btn-group {
        flex-direction: column;
      }
      
      .action-buttons {
        flex-direction: column;
      }
      
      .stats-bar {
        flex-wrap: wrap;
        gap: 15px;
      }
      
      .stat-item {
        flex: 1;
        min-width: 100px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Заголовок приложения -->
    <div class="app-header">
      <h1 class="app-title">Калькулятор метрик</h1>
      <p class="app-subtitle">Оцените эффективность вашей подписной модели</p>
    </div>

    <!-- Панель статистики -->
    <div class="stats-bar">
      <div class="stat-item">
        <div class="stat-value" id="tgLTV">--</div>
        <div class="stat-label">LTV</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="tgCAC">--</div>
        <div class="stat-label">CAC</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="tgEfficiency">--</div>
        <div class="stat-label">Эффективность</div>
      </div>
    </div>

    <div class="grid">
      <!-- ВХОДНЫЕ ПОКАЗАТЕЛИ -->
      <div class="card">
        <h2 class="card-title">Входные данные</h2>
        
        <div class="form-group">
          <label for="startSubs">Начальное количество подписчиков</label>
          <input type="number" id="startSubs" min="0" placeholder="Количество активных клиентов">
        </div>
        
        <div class="form-group">
          <label for="churnUsers">Отток за период</label>
          <input type="number" id="churnUsers" min="0" placeholder="Количество отписавшихся">
        </div>
        
        <div class="form-group">
          <label for="marketingSpend">Маркетинговые расходы, ₽</label>
          <input type="number" id="marketingSpend" min="0" placeholder="Затраты на рекламу">
        </div>
        
        <div class="form-group">
          <label for="newSubs">Новые подписчики</label>
          <input type="number" id="newSubs" min="0" placeholder="Количество новых клиентов">
        </div>
        
        <div class="form-group">
          <label for="newSubsMonthly">Новых в месяц</label>
          <input type="number" id="newSubsMonthly" min="0" placeholder="Стабильный поток">
        </div>
        
        <div class="form-group">
          <label for="price">Стоимость подписки, ₽</label>
          <input type="number" id="price" min="0" step="0.01" placeholder="Цена подписки">
        </div>
        
        <div class="form-group">
          <label for="grossMargin">Валовая маржа, %</label>
          <input type="number" id="grossMargin" min="0" max="100" placeholder="Доля прибыли">
        </div>
        
        <div class="btn-group">
          <button class="btn pulse" onclick="calculate()">
            <span>🚀</span> Рассчитать
          </button>
          <button class="btn btn-secondary" onclick="resetForm()">
            <span>🔄</span> Сброс
          </button>
        </div>
      </div>
      
      <!-- РЕЗУЛЬТАТЫ -->
      <div class="card">
        <h2 class="card-title">Результаты</h2>
        
        <div id="results" class="results">
          <div style="grid-column: 1/-1; text-align: center; padding: 20px; color: #64748b;">
            Введите данные и нажмите "Рассчитать"
          </div>
        </div>
        
        <div class="traffic-light">
          <div id="trafficLight" class="light neutral">?</div>
        </div>
        
        <div class="action-buttons">
          <button class="action-btn share-btn" onclick="shareResults()">
            <span>📤</span> Поделиться
          </button>
          <button class="action-btn report-btn" onclick="generateReport()">
            <span>📊</span> Отчет
          </button>
        </div>
      </div>
    </div>
    
    <!-- АНАЛИТИЧЕСКАЯ ПАНЕЛЬ -->
    <div class="card">
      <h2 class="card-title">Аналитика</h2>
      
      <div class="chart-container">
        <canvas id="metricsChart"></canvas>
      </div>
      
      <div class="detailed-metrics">
        <div class="detail-metric">
          <div class="detail-metric-label">ROMI</div>
          <div class="detail-metric-value" id="romi">--</div>
        </div>
        <div class="detail-metric">
          <div class="detail-metric-label">Окупаемость</div>
          <div class="detail-metric-value" id="breakEven">--</div>
        </div>
      </div>
      
      <div class="efficiency-card">
        <h3 class="efficiency-title">Эффективность бизнеса</h3>
        <div class="progress-bar">
          <div class="progress-fill" id="efficiencyBar"></div>
        </div>
        <div class="efficiency-text" id="summaryText">
          Введите данные для анализа
        </div>
      </div>
    </div>
  </div>
  
  <div id="toast" class="toast">Результаты скопированы!</div>

  <script>
    // Инициализация Telegram Web App
    let tg = window.Telegram.WebApp;
    tg.expand();
    tg.ready();
    
    // Функция показа уведомлений
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }
    
    // Функция форматирования чисел
    const fmt = (n, d = 2) => {
      return new Intl.NumberFormat('ru-RU', {
        maximumFractionDigits: d,
        minimumFractionDigits: d
      }).format(n);
    };
    
    // Получение элементов DOM
    const elements = {
      startSubs: document.getElementById('startSubs'),
      churnUsers: document.getElementById('churnUsers'),
      marketingSpend: document.getElementById('marketingSpend'),
      newSubs: document.getElementById('newSubs'),
      newSubsMonthly: document.getElementById('newSubsMonthly'),
      price: document.getElementById('price'),
      grossMargin: document.getElementById('grossMargin'),
      results: document.getElementById('results'),
      trafficLight: document.getElementById('trafficLight'),
      romi: document.getElementById('romi'),
      breakEven: document.getElementById('breakEven'),
      efficiencyBar: document.getElementById('efficiencyBar'),
      summaryText: document.getElementById('summaryText'),
      tgLTV: document.getElementById('tgLTV'),
      tgCAC: document.getElementById('tgCAC'),
      tgEfficiency: document.getElementById('tgEfficiency')
    };
    
    // Инициализация графика
    const ctx = document.getElementById('metricsChart').getContext('2d');
    const metricsChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: ['Янв', 'Фев', 'Мар', 'Апр', 'Май', 'Июн'],
        datasets: [{
          label: 'LTV',
          data: [12000, 13500, 14200, 15000, 15800, 16500],
          borderColor: '#6366f1',
          backgroundColor: 'rgba(99, 102, 241, 0.1)',
          tension: 0.4,
          fill: true
        }, {
          label: 'CAC',
          data: [8000, 8200, 7900, 8100, 7800, 7600],
          borderColor: '#10b981',
          backgroundColor: 'rgba(16, 185, 129, 0.1)',
          tension: 0.4,
          fill: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'top',
            labels: {
              usePointStyle: true,
              padding: 20,
              font: {
                size: 12,
                weight: '600'
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            grid: {
              color: 'rgba(0, 0, 0, 0.05)'
            },
            ticks: {
              font: {
                size: 11
              }
            }
          },
          x: {
            grid: {
              display: false
            },
            ticks: {
              font: {
                size: 11
              }
            }
          }
        }
      }
    });
    
    // Функция расчета ROMI
    function calculateROMI(ltv, cac) {
      return ((ltv - cac) / cac * 100).toFixed(1);
    }
    
    // Функция расчета break-even
    function calculateBreakEven(cac, arpu) {
      return (cac / arpu).toFixed(1);
    }
    
    // Функция получения текста сводки
    function getSummaryText(efficiency) {
      if (efficiency >= 80) return "🚀 Отличная эффективность! Ваш бизнес очень устойчив.";
      if (efficiency >= 60) return "⚡ Хорошая эффективность. Есть потенциал для улучшения.";
      if (efficiency >= 40) return "⚠️ Средняя эффективность. Рекомендуется оптимизация.";
      return "🔴 Низкая эффективность. Требуется срочное вмешательство.";
    }
    
    // Основная функция расчета
    function calculate() {
      // Получение значений из полей
      const data = {
        startSubs: parseFloat(elements.startSubs.value) || 0,
        churnUsers: parseFloat(elements.churnUsers.value) || 0,
        marketingSpend: parseFloat(elements.marketingSpend.value) || 0,
        newSubs: parseFloat(elements.newSubs.value) || 0,
        newSubsMonthly: parseFloat(elements.newSubsMonthly.value) || 0,
        price: parseFloat(elements.price.value) || 0,
        grossMargin: parseFloat(elements.grossMargin.value) || 0
      };
      
      // Расчет метрик
      const churnRate = data.startSubs > 0 ? data.churnUsers / data.startSubs : 0;
      const retention = 1 - churnRate;
      const cac = data.newSubs > 0 ? data.marketingSpend / data.newSubs : 0;
      const arpu = data.price * (data.grossMargin / 100);
      const ltv = retention > 0 && retention < 1 ? arpu * (retention / (1 - retention)) : 0;
      const payback = arpu > 0 ? cac / arpu : 0;
      const ratio = ltv > 0 ? cac / ltv : 0;
      
      // Расчет дополнительных метрик
      const romi = calculateROMI(ltv, cac);
      const breakEven = calculateBreakEven(cac, arpu);
      const efficiency = Math.min(100, Math.max(0, (ltv / cac - 1) * 50));
      
      // Обновление результатов
      elements.results.innerHTML = `
        <div class="metric-card">
          <div class="metric-label">Отток</div>
          <div class="metric-value">${fmt(churnRate * 100)}%</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Удержание</div>
          <div class="metric-value">${fmt(retention * 100)}%</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">CAC</div>
          <div class="metric-value">${fmt(cac)} ₽</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">LTV</div>
          <div class="metric-value">${fmt(ltv)} ₽</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Окупаемость</div>
          <div class="metric-value">${fmt(payback, 1)} мес.</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">CAC/LTV</div>
          <div class="metric-value">${fmt(ratio * 100)}%</div>
        </div>
      `;
      
      // Обновление светофора
      if (ratio <= 0.33 && payback <= 6) {
        elements.trafficLight.className = 'light green';
        elements.trafficLight.textContent = '✓';
      } else if (ratio <= 0.50 && payback <= 12) {
        elements.trafficLight.className = 'light yellow';
        elements.trafficLight.textContent = '!';
      } else {
        elements.trafficLight.className = 'light red';
        elements.trafficLight.textContent = '✗';
      }
      
      // Обновление детальных метрик
      elements.romi.textContent = romi + '%';
      elements.breakEven.textContent = breakEven + ' мес.';
      
      // Обновление сводки
      elements.efficiencyBar.style.width = efficiency + '%';
      elements.summaryText.textContent = getSummaryText(efficiency);
      
      // Обновление Telegram статистики
      elements.tgLTV.textContent = fmt(ltv) + ' ₽';
      elements.tgCAC.textContent = fmt(cac) + ' ₽';
      elements.tgEfficiency.textContent = efficiency.toFixed(0) + '%';
      
      // Обновление графика
      updateChart(ltv, cac);
      
      // Вибрация для обратной связи
      if (tg.HapticFeedback) {
        tg.HapticFeedback.impactOccurred('medium');
      }
      
      showToast('Расчет завершен!');
    }
    
    // Функция обновления графика
    function updateChart(ltv, cac) {
      const currentMonth = new Date().toLocaleString('ru', { month: 'short' });
      
      metricsChart.data.datasets[0].data.push(ltv);
      if (metricsChart.data.datasets[0].data.length > 6) {
        metricsChart.data.datasets[0].data.shift();
      }
      
      metricsChart.data.datasets[1].data.push(cac);
      if (metricsChart.data.datasets[1].data.length > 6) {
        metricsChart.data.datasets[1].data.shift();
      }
      
      metricsChart.data.labels.push(currentMonth);
      if (metricsChart.data.labels.length > 6) {
        metricsChart.data.labels.shift();
      }
      
      metricsChart.update();
    }
    
    // Функция сброса формы
    function resetForm() {
      elements.startSubs.value = '';
      elements.churnUsers.value = '';
      elements.marketingSpend.value = '';
      elements.newSubs.value = '';
      elements.newSubsMonthly.value = '';
      elements.price.value = '';
      elements.grossMargin.value = '';
      
      elements.results.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 20px; color: #64748b;">Введите данные и нажмите "Рассчитать"</div>';
      elements.trafficLight.className = 'light neutral';
      elements.trafficLight.textContent = '?';
      
      elements.romi.textContent = '--';
      elements.breakEven.textContent = '--';
      
      elements.efficiencyBar.style.width = '0%';
      elements.summaryText.textContent = 'Введите данные для анализа';
      
      elements.tgLTV.textContent = '--';
      elements.tgCAC.textContent = '--';
      elements.tgEfficiency.textContent = '--';
      
      showToast('Форма сброшена');
    }
    
    // Функция поделиться результатами
    function shareResults() {
      const resultsText = document.getElementById('results').innerText;
      
      if (resultsText && resultsText !== 'Введите данные и нажмите "Рассчитать"') {
        tg.shareMessage(`📊 Результаты расчета метрик подписки:\n\n${resultsText}`);
        showToast('Результаты отправлены!');
      } else {
        showToast('Сначала выполните расчет');
      }
    }
    
    // Функция генерации отчета
    function generateReport() {
      // Получаем текущие данные
      const data = {
        startSubs: parseFloat(elements.startSubs.value) || 0,
        churnUsers: parseFloat(elements.churnUsers.value) || 0,
        marketingSpend: parseFloat(elements.marketingSpend.value) || 0,
        newSubs: parseFloat(elements.newSubs.value) || 0,
        newSubsMonthly: parseFloat(elements.newSubsMonthly.value) || 0,
        price: parseFloat(elements.price.value) || 0,
        grossMargin: parseFloat(elements.grossMargin.value) || 0
      };
      
      // Расчет метрик
      const churnRate = data.startSubs > 0 ? data.churnUsers / data.startSubs : 0;
      const retention = 1 - churnRate;
      const cac = data.newSubs > 0 ? data.marketingSpend / data.newSubs : 0;
      const arpu = data.price * (data.grossMargin / 100);
      const ltv = retention > 0 && retention < 1 ? arpu * (retention / (1 - retention)) : 0;
      const payback = arpu > 0 ? cac / arpu : 0;
      const ratio = ltv > 0 ? cac / ltv : 0;
      const romi = calculateROMI(ltv, cac);
      const breakEven = calculateBreakEven(cac, arpu);
      const efficiency = Math.min(100, Math.max(0, (ltv / cac - 1) * 50));
      
      // Определяем статус эффективности
      let status, statusColor, recommendations;
      if (efficiency >= 80) {
        status = "Отличная эффективность";
        statusColor = "#27ae60";
        recommendations = `
          <ul>
            <li>🚀 Масштабируйте бизнес: увеличивайте бюджет на маркетинг</li>
            <li>🌍 Расширяйте географию присутствия</li>
            <li>📦 Добавляйте новые продукты или услуги</li>
            <li>⭐ Поддерживайте высокий уровень сервиса</li>
          </ul>
        `;
      } else if (efficiency >= 60) {
        status = "Хорошая эффективность";
        statusColor = "#f39c12";
        recommendations = `
          <ul>
            <li>📈 Работайте над удержанием клиентов</li>
            <li>🎯 Оптимизируйте маркетинговые каналы</li>
            <li>🔧 Улучшайте продукт на основе обратной связи</li>
            <li>💡 Тестируйте новые стратегии монетизации</li>
          </ul>
        `;
      } else {
        status = "Требуется улучшение";
        statusColor = "#e74c3c";
        recommendations = `
          <ul>
            <li>⬇️ Срочно снижайте стоимость привлечения клиентов (CAC)</li>
            <li>⬆️ Повышайте пожизненную ценность клиента (LTV)</li>
            <li>🔄 Пересмотрите бизнес-модель</li>
            <li>📊 Проанализируйте и оптимизируйте все процессы</li>
          </ul>
        `;
      }
      
      // Создаем HTML отчета
      const reportHTML = `
        <!DOCTYPE html>
        <html lang="ru">
        <head>
          <meta charset="UTF-8"/>
          <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
          <title>Отчет по метрикам подписки</title>
          <style>
            body {
              font-family: 'Arial', sans-serif;
              line-height: 1.6;
              color: #333;
              margin: 0;
              padding: 20px;
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            }
            
            .report-container {
              max-width: 800px;
              margin: 0 auto;
              padding: 30px;
              background: white;
              border-radius: 20px;
              box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            }
            
            .report-header {
              text-align: center;
              margin-bottom: 40px;
              padding-bottom: 20px;
              border-bottom: 2px solid #f1f5f9;
            }
            
            .report-title {
              color: #1e293b;
              font-size: 32px;
              margin-bottom: 10px;
              font-weight: 800;
            }
            
            .report-date {
              color: #64748b;
              font-size: 16px;
            }
            
            .report-section {
              margin-bottom: 40px;
            }
            
            .report-section-title {
              color: #6366f1;
              font-size: 24px;
              margin-bottom: 20px;
              padding-bottom: 10px;
              border-bottom: 2px solid #e2e8f0;
              font-weight: 700;
            }
            
            .report-table {
              width: 100%;
              border-collapse: collapse;
              margin-bottom: 30px;
              background: white;
              border-radius: 12px;
              overflow: hidden;
              box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            }
            
            .report-table th, .report-table td {
              padding: 15px;
              text-align: left;
              border-bottom: 1px solid #f1f5f9;
            }
            
            .report-table th {
              background: #f8fafc;
              font-weight: 700;
              color: #475569;
            }
            
            .report-metric {
              background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
              border-radius: 16px;
              padding: 20px;
              margin-bottom: 20px;
              box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            }
            
            .report-metric-title {
              font-weight: 700;
              color: #475569;
              margin-bottom: 10px;
              font-size: 18px;
            }
            
            .report-metric-value {
              font-size: 28px;
              font-weight: 800;
              color: #6366f1;
            }
            
            .report-efficiency {
              text-align: center;
              margin: 40px 0;
            }
            
            .report-efficiency-bar {
              height: 30px;
              background: linear-gradient(to right, #ef4444, #f59e0b, #10b981);
              border-radius: 15px;
              position: relative;
              margin: 25px 0;
            }
            
            .report-efficiency-marker {
              position: absolute;
              top: -15px;
              width: 60px;
              height: 60px;
              background-color: white;
              border: 5px solid #6366f1;
              border-radius: 50%;
              transform: translateX(-50%);
              display: flex;
              align-items: center;
              justify-content: center;
              font-weight: 800;
              font-size: 18px;
            }
            
            .report-recommendations {
              background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
              border-radius: 16px;
              padding: 25px;
              margin: 30px 0;
            }
            
            .report-recommendations h3 {
              margin-top: 0;
              color: #4338ca;
              font-size: 22px;
              margin-bottom: 15px;
            }
            
            .report-recommendations ul {
              margin-bottom: 0;
              padding-left: 20px;
            }
            
            .report-recommendations li {
              margin-bottom: 10px;
              font-size: 16px;
            }
            
            .report-footer {
              text-align: center;
              margin-top: 50px;
              padding-top: 20px;
              border-top: 1px solid #e2e8f0;
              color: #64748b;
              font-size: 14px;
            }
            
            @media print {
              body {
                background: white;
                padding: 0;
              }
              
              .report-container {
                box-shadow: none;
                max-width: 100%;
                margin: 0;
                padding: 20px;
              }
            }
          </style>
        </head>
        <body>
          <div class="report-container">
            <div class="report-header">
              <h1 class="report-title">📊 Отчет по метрикам подписки</h1>
              <div class="report-date">Дата создания: ${new Date().toLocaleDateString('ru-RU')}</div>
            </div>
            
            <div class="report-section">
              <h2 class="report-section-title">📝 Входные данные</h2>
              <table class="report-table">
                <tr>
                  <th>Показатель</th>
                  <th>Значение</th>
                </tr>
                <tr>
                  <td>Начальное количество подписчиков</td>
                  <td>${fmt(data.startSubs)}</td>
                </tr>
                <tr>
                  <td>Отток за период</td>
                  <td>${fmt(data.churnUsers)}</td>
                </tr>
                <tr>
                  <td>Маркетинговые расходы</td>
                  <td>${fmt(data.marketingSpend)} ₽</td>
                </tr>
                <tr>
                  <td>Новые подписчики за период</td>
                  <td>${fmt(data.newSubs)}</td>
                </tr>
                <tr>
                  <td>Новые подписчики в месяц</td>
                  <td>${fmt(data.newSubsMonthly)}</td>
                </tr>
                <tr>
                  <td>Стоимость подписки</td>
                  <td>${fmt(data.price)} ₽</td>
                </tr>
                <tr>
                  <td>Валовая маржа</td>
                  <td>${fmt(data.grossMargin)}%</td>
                </tr>
              </table>
            </div>
            
            <div class="report-section">
              <h2 class="report-section-title">📈 Результаты расчетов</h2>
              
              <div class="report-metric">
                <div class="report-metric-title">Отток (Churn Rate)</div>
                <div class="report-metric-value">${fmt(churnRate * 100)}%</div>
              </div>
              
              <div class="report-metric">
                <div class="report-metric-title">Удержание (Retention Rate)</div>
                <div class="report-metric-value">${fmt(retention * 100)}%</div>
              </div>
              
              <div class="report-metric">
                <div class="report-metric-title">Стоимость привлечения (CAC)</div>
                <div class="report-metric-value">${fmt(cac)} ₽</div>
              </div>
              
              <div class="report-metric">
                <div class="report-metric-title">Пожизненная ценность (LTV)</div>
                <div class="report-metric-value">${fmt(ltv)} ₽</div>
              </div>
              
              <div class="report-metric">
                <div class="report-metric-title">Окупаемость</div>
                <div class="report-metric-value">${fmt(payback, 1)} мес.</div>
              </div>
              
              <div class="report-metric">
                <div class="report-metric-title">Соотношение CAC/LTV</div>
                <div class="report-metric-value">${fmt(ratio * 100)}%</div>
              </div>
              
              <div class="report-metric">
                <div class="report-metric-title">ROMI</div>
                <div class="report-metric-value">${romi}%</div>
              </div>
              
              <div class="report-metric">
                <div class="report-metric-title">Точка безубыточности</div>
                <div class="report-metric-value">${breakEven} мес.</div>
              </div>
            </div>
            
            <div class="report-section">
              <h2 class="report-section-title">🎯 Сводка эффективности</h2>
              
              <div class="report-efficiency">
                <div style="font-size: 20px; margin-bottom: 15px; color: #475569; font-weight: 600;">Уровень эффективности вашего бизнеса</div>
                <div class="report-efficiency-bar">
                  <div class="report-efficiency-marker" style="left: ${efficiency}%; color: ${statusColor};">
                    ${efficiency.toFixed(0)}%
                  </div>
                </div>
                <div style="font-size: 28px; font-weight: 800; color: ${statusColor}; margin-top: 20px;">
                  ${status}
                </div>
              </div>
              
              <div class="report-recommendations">
                <h3>🚀 Рекомендации:</h3>
                ${recommendations}
              </div>
            </div>
            
            <div class="report-footer">
              <p>Отчет сгенерирован с помощью калькулятора метрик подписки</p>
              <p>Для сохранения в PDF используйте функцию печати браузера (Ctrl+P)</p>
            </div>
          </div>
        </body>
        </html>
      `;
      
      // Открываем отчет в новом окне
      const reportWindow = window.open('', '_blank');
      reportWindow.document.write(reportHTML);
      reportWindow.document.close();
      
      showToast('Отчет создан!');
    }
    
    // Инициализация
    resetForm();
    
    // Обработчики событий
    Object.values(elements).forEach(element => {
      if (element.tagName === 'INPUT') {
        element.addEventListener('input', calculate);
      }
    });
  </script>
</body>
</html>
